name: Validate Changes

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  lint-with-psscriptanalyzer:
    name: Lint with PSScriptAnalyzer
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository code
        uses: actions/checkout@v3
      - name: Lint with PSScriptAnalyzer
        uses: pwshrc/actions-invoke-lib-dependent-pwsh@v0.2.0
        with:
          run: ./build/lint.ps1 -CI -NoFail:([bool]"${{ secrets.MANDATE_LINT_SUCCESS != 'true' }}")

  determine-version:
    name: Determine Version with GitVersion
    runs-on: ubuntu-latest
    steps:
    - name: Populate GitVersion variables
      id: gitversion_vars
      uses: pwshrc/actions-determine-version@v0.8.0
      with:
        mode: 'upload'

  create-releasenotes:
    name: Create Release Notes
    needs: determine-version
    runs-on: ubuntu-latest
    steps:
    - name: Check out repository full history
      uses: actions/checkout@v3
      with:
        fetch-depth: 0  # create-release-notes requires the full history to create the release notes.
    - name: Populate GitVersion variables
      id: gitversion_vars
      uses: pwshrc/actions-determine-version@v0.8.0
      with:
        mode: 'download'
    - name: Create release notes
      id: create_release_notes
      uses: mikepenz/release-changelog-builder-action@v4
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        fromTag: ${{ steps.gitversion_vars.outputs.VersionSourceSha }}
        toTag: ${{ steps.gitversion_vars.outputs.Sha }}
        commitMode: true
        outputFile: ./release-notes.md
    - name: "Create artifact: release-notes.md"
      uses: actions/upload-artifact@v3
      with:
        name: release-notes.md
        path: ./release-notes.md
        if-no-files-found: error

  build-release-package:
    name: Build Release Package
    needs: [create-releasenotes]
    runs-on: ubuntu-latest
    steps:
    - name: Check out repository code
      uses: actions/checkout@v3
    - name: Populate GitVersion variables
      id: gitversion_vars
      uses: pwshrc/actions-determine-version@v0.8.0
      with:
        mode: 'download'
    - name: "Get artifact: release-notes.md"
      uses: actions/download-artifact@v3
      with:
        name: release-notes.md
        path: ./out/
    - name: Build PSGallery package
      uses: pwshrc/actions-invoke-lib-dependent-pwsh@v0.2.0
      env:
        PackageVersionNuGet: ${{ steps.gitversion_vars.outputs.NuGetVersionV2 }}
        PackageVersionMajorMinorPatchBuild: ${{ steps.gitversion_vars.outputs.AssemblySemVer }}
        PackageVersionPrereleaseTag: ${{ steps.gitversion_vars.outputs.PreReleaseTag }}
        CommitSha: ${{ steps.gitversion_vars.outputs.Sha }}
      with:
        run: |
          [string] $releaseNotes = (Get-Content -Raw -Path ./out/release-notes.md -Encoding UTF8).Trim()
          ./build/package.ps1 -PackageVersionNuGet $Env:PackageVersionNuGet -PackageVersionMajorMinorPatchBuild $Env:PackageVersionMajorMinorPatchBuild -PackageVersionPrereleaseTag $Env:PackageVersionPrereleaseTag -ReleaseNotes $releaseNotes -CommitSha $Env:CommitSha
    - name: "Create artifact: PSGallery-package"
      uses: actions/upload-artifact@v3
      with:
        name: PSGallery-package
        path: ./out/*.nupkg
        if-no-files-found: error

  tests:
    name: Test with Pester on ${{ matrix.os }}
    continue-on-error: ${{ matrix.experimental == 'true' }}
    strategy:
      fail-fast: ${{ github.ref == 'refs/heads/main' }}
      matrix:
        # See: https://docs.github.com/en/actions/using-github-hosted-runners/about-github-hosted-runners
        os: [ubuntu-latest, windows-latest, macos-latest, ubuntu-20.04, windows-2019]
        include:
          - os: windows-latest
            codecov_os: windows
          - os: ubuntu-latest
            codecov_os: linux
          - os: macos-latest
            codecov_os: macos
            experimental: true
          - os: ubuntu-20.04
            codecov_os: linux
            experimental: true
          - os: windows-2019
            codecov_os: windows
            experimental: true
    runs-on: ${{ matrix.os }}
    needs: build-release-package
    steps:
    - name: Check out repository code
      uses: actions/checkout@v3
    - name: "Get artifact: PSGallery-package"
      uses: actions/download-artifact@v3
      with:
        name: PSGallery-package
        path: ./out/
    - name: Test with Pester
      uses: pwshrc/actions-invoke-lib-dependent-pwsh@v0.2.0
      with:
        run: ./build/test.ps1 -UsePackageExport -CI -OutputFilesPrefix "${{ matrix.os }}-" -NoFail:([bool]"${{ matrix.experimental }}")
    - name: "Create artifact: tests-${{ matrix.os }}"
      uses: actions/upload-artifact@v3
      if: ${{ always() }}
      with:
        name: "tests-${{ matrix.os }}"
        path: ./out/*.xml
        if-no-files-found: error
    - name: Upload coverage report to Codecov
      uses: codecov/codecov-action@v3
      if: ${{ (github.ref == 'refs/heads/main') }}
      with:
        fail_ci_if_error: true
        flags: ${{ matrix.codecov_os }},unittests
        directory: ./out
        files: "*coverage.xml"
        os: ${{ matrix.codecov_os }}
        env_vars: "OS"
